<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width">
	<title>Resource Priorities</title>
	<link rel="stylesheet" href="css/site.css">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
</head>

<body>
		<article class="fc-graphic-article">
		<ul class="fc-decorative-border">
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
		</ul>
		<div class="fc-graphic-container">
			<h6 class="fc-graphic-overline">2008-2013</h6>
			<h4 class="fc-graphic-title">Resource Priorities</h4>
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">In <span class="fc-graphic-dropdown-wrapper">Alaska</span> donors funded:</h5>
				<ol class="fc-graphic-trend-list">
					<li class="fc-graphic-trend-item">74% of teachersâ€™ 7,603 requests (30th of 50)</li>
					<li class="fc-graphic-trend-item">88% of Applied Learning requests (1st of 50)</li>
					<li class="fc-graphic-trend-item">38% of Special Needs requests (49th of 50)</li>
				</ol>	
			</section>
			<section class="fc-graphic-content-block">
				<div class="fc-stacked-bar">
				</div>
				<ol class="fc-graphic-legend">
					<li class="fc-graphic-legend-item">Literacy &amp; Language</li>
					<li class="fc-graphic-legend-item">Special Needs</li>
					<li class="fc-graphic-legend-item">Math &amp; Science</li>
					<li class="fc-graphic-legend-item">History &amp; Civics</li>
					<li class="fc-graphic-legend-item">Music &amp; Arts</li>
					<li class="fc-graphic-legend-item">Health &amp; Sports</li>
					<li class="fc-graphic-legend-item">Applied Learning</li>
					<li class="fc-graphic-legend-item">Insignificant Data</li>
				</ol>	
			</section>
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">Explore the Extremes</h5>
				<ol class="fc-graphic-extremes-list">
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Most Funded Overall</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Least Resource Requests</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Most Resource Requests</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Least Funded Overall</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Most Funded Music &amp; Arts</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Least Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Most Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Least Funded Special Needs</a></li>
					<li class="fc-graphic-extremes-item"><a href="#" class="fc-graphic-tag">Most Funded Applied Learning</a></li>
				</ol>	
			</section>
			<span class="sources-copy"><span class="sources-leadin">SOURCE</span> Donors Choose</span>
		</div>

		<!-- D3 BAR LAYOUT -->
		<script type="text/javascript">
		(function() {
			// Global vars
			var x;
			var labels;

			// Config vars
			var valueLabelWidth = 30; // Space reserved for value labels (right)
			var barHeight = 20; // Height of one bar
			var barPadding = 5; // Padding between bars
			var barLabelWidth = 100; // Space reserved for bar labels
			var barLabelPadding = 5; // Padding between bar and bar labels (left)
			var gridLabelHeight = 15; // Space reserved for gridline labels
			var gridChartOffset = 3; // Space between start of grid and first bar
			var width = parseInt(d3.select('.fc-stacked-bar').style('width'), 10);

			// Formatting
			var formatCurrency = d3.format("$,");
			var formatGeo = d3.format(",");
			var formatBils = d3.format('$.3s');
			var bilsReplace = function(val) { return formatBils(val).replace(/G/, ' bil.').replace(/T/, ' tril.') };

			// Accessor functions 
			var barLabel = function(d) { return d['nation']; };
			var barValue = function(d) { return parseFloat(d['adj_medals']); };
			var barGeo = function(d) { return formatGeo(d['geog_area']); };
			var barGDP = function(d) { return formatCurrency(d['gdp_per_cap']); };
			var barExport = function(d) { return bilsReplace(d['exports']); };
			var barLat = function(d) { return d['lat_of_capital']; };
			var height = function(sortedData) { return gridLabelHeight + gridChartOffset + sortedData.length * barHeight; };

			// SVG container element
			var bar_chart = d3.select('.fc-stacked-bar').append("svg")
				.attr("xmlns","http://www.w3.org/2000/svg")
	            .attr("xmlns","http://www.w3.org/1999/xlink")
	            .attr("version","1.1")
				.attr("class", "bar-chart")
				.attr('width', width);

			// DAT DATA		
			d3.csv('medals.csv', function(data){

				// Sorting
				var sortedData = data.sort(function(a, b) {
					return d3.descending(barValue(a), barValue(b));
				}); 

				// Set chart height now that we have data
				bar_chart.attr('height', height(sortedData));

				// Scales
				var yScale = d3.scale.ordinal().domain(d3.range(0, sortedData.length)).rangeBands([0, sortedData.length * barHeight]);
				var y = function(d, i) { return yScale(i); };
				var yPad = function(d, i) { return yScale(i) + (barPadding/2); };
				var yText = function(d, i) { return y(d, i) + yScale.rangeBand() / 2; };
				x = d3.scale.linear()
					.domain([0, d3.max(sortedData, barValue)])
					.range([0, width - barLabelWidth - valueLabelWidth]);

				// Bar labels
				var labelsContainer = bar_chart.append('g')
					.attr('transform', 'translate(' + (barLabelWidth - barLabelPadding) + ',' + (gridLabelHeight + gridChartOffset) + ')'); 
				
				labelsContainer.selectAll('text')
					.data(sortedData)
					.enter()
				  .append('text')
					.attr('y', yText)
					.attr('stroke', 'none')
					.attr('fill', 'black')
					.attr("dy", ".35em") // vertical-align: middle
					.attr('text-anchor', 'end')
					.attr("class", "name")
					.text(barLabel);

				// Background bars
				var barsBG = bar_chart.append('g')
					.attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')'); 
				
				barsBG.selectAll("rect")
					.data(sortedData)
					.enter()
				  .append("rect")
					.attr('y', y)
					.attr('height', yScale.rangeBand())
					.attr('width', function(d) { return x(barValue(d)); })
					.attr("class", "bar-bg");

				// Bars
				var barsContainer = bar_chart.append('g')
					.attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')'); 
				
				barsContainer.selectAll("rect")
					.data(sortedData)
					.enter()
				  .append("rect")
					.attr('y', yPad)
					.attr('height', yScale.rangeBand() - barPadding)
					.attr('width', function(d) { return x(barValue(d)); })
					.attr("class", "bar")
					.on("mouseover", function(d) {      
						div.transition()        
						.duration(200)      
						.style("opacity", 1);      
						div .html(
							"<p class='tooltip-title'>"+ barLabel(d) +"</p>" +
							"<p class='tooltip-param'>Geographic Area: "+ barGeo(d) +" km<sup>2</sup></p>" +
							"<p class='tooltip-param'>GDP per Capita: "+ barGDP(d) +"</p>" +
							"<p class='tooltip-param'>Exports: "+ barExport(d) +"</p>" +
							"<p class='tooltip-param'>Latitude of Capital: "+ barLat(d) + "&#176;</p>"
						)
						.style("left", (d3.event.pageX + 10) + "px")     
						.style("top", (d3.event.pageY - 20) + "px");    
					})                  
					.on("mouseout", function(d) {       
						div.transition()        
						.duration(500)      
						.style("opacity", 0);   
					});

					// Bar value labels
					labels = barsContainer.selectAll("text")
						.data(sortedData)
						.enter()
					  .append("text")
						.attr("x", function(d) { return x(barValue(d)); })
						.attr("y", yText)
						.attr("dx", 3) // padding-left
						.attr("dy", ".35em") // vertical-align: middle
						.attr("text-anchor", "start") // text-align: right
						.attr("fill", "black")
						.attr("stroke", "none")
						.attr("class", "value-labels")
						.text(function(d) { return d3.round(barValue(d), 2); });

					// X-axis label
					axisLabel = bar_chart.append('text')
						.attr('transform', 'translate(' + ((width-100)/2 + 80) + ',' + gridLabelHeight + ')') 
						.attr("dy", -3)
						.attr("text-anchor", "middle")
						.attr("class", "x-axis-label")
						.text("Predicted Medals");

					// Tooltipz
					var div = d3.select("body").append("div")   
						.attr("class", "graphic-tooltip")               
						.style("opacity", 0);
				});


				// Resize
				d3.select(window).on('resize', resize);


				// Helper Functions		 
				function resize() {

					// Update width
					width = parseInt(d3.select('.fc-stacked-bar').style('width'), 10);

					// Resize the chart
					x.range([0, width - barLabelWidth - valueLabelWidth]);
					d3.select(bar_chart.node().parentNode)
					bar_chart.style('width', width);

					// Resize the bars
					bar_chart.selectAll('rect')
					.attr('width', function(d) {
						return x(barValue(d));
					});

					// Update value position
					labels.attr("x", function(d) {
						return x(d.adj_medals);
					})

					// Update x-axis label position
					axisLabel.attr('transform', 'translate(' + ((width-100)/2 + 80) + ',' + gridLabelHeight + ')');
				};
			})();

		</script>

	</article>

</body>

</html>
