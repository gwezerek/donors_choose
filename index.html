<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width">
	<title>Resource Priorities</title>
	<link rel="stylesheet" href="css/site.css">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
</head>

<body>
		<article class="fc-graphic-article">
		<ul class="fc-decorative-border">
			<li class="fc-decorative-border-box LiteracyLanguage"></li>
			<li class="fc-decorative-border-box MathScience"></li>
			<li class="fc-decorative-border-box MusictheArts"></li>
			<li class="fc-decorative-border-box AppliedLearning"></li>
			<li class="fc-decorative-border-box SpecialNeeds"></li>
			<li class="fc-decorative-border-box HistoryCivics"></li>
			<li class="fc-decorative-border-box HealthSports"></li>
		</ul>
		<div class="fc-graphic-container">
			<h6 class="fc-graphic-overline">2008-2013</h6>
			<h4 class="fc-graphic-title">Resource Priorities</h4>
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">In 
				<select class="fc-graphic-select" tabindex="-1">
					<option value="AL">Alabama</option>
					<option value="AK">Alaska</option>
					<option value="AZ">Arizona</option>
					<option value="AR">Arkansas</option>
					<option value="CA">California</option>
					<option value="CO">Colorado</option>
					<option value="CT">Connecticut</option>
					<option value="DE">Delaware</option>
					<option value="FL">Florida</option>
					<option value="GA">Georgia</option>
					<option value="HI">Hawaii</option>
					<option value="ID">Idaho</option>
					<option value="IL">Illinois</option>
					<option value="IN">Indiana</option>
					<option value="IA">Iowa</option>
					<option value="KS">Kansas</option>
					<option value="KY">Kentucky</option>
					<option value="LA">Louisiana</option>
					<option value="ME">Maine</option>
					<option value="MD">Maryland</option>
					<option value="MA">Massachusetts</option>
					<option value="MI">Michigan</option>
					<option value="MN">Minnesota</option>
					<option value="MS">Mississippi</option>
					<option value="MO">Missouri</option>
					<option value="MT">Montana</option>
					<option value="NE">Nebraska</option>
					<option value="NV">Nevada</option>
					<option value="NH">New Hampshire</option>
					<option value="NJ">New Jersey</option>
					<option value="NM">New Mexico</option>
					<option value="NY" selected>New York</option>
					<option value="NC">North Carolina</option>
					<option value="ND">North Dakota</option>
					<option value="OH">Ohio</option>
					<option value="OK">Oklahoma</option>
					<option value="OR">Oregon</option>
					<option value="PA">Pennsylvania</option>
					<option value="RI">Rhode Island</option>
					<option value="SC">South Carolina</option>
					<option value="SD">South Dakota</option>
					<option value="TN">Tennessee</option>
					<option value="TX">Texas</option>
					<option value="UT">Utah</option>
					<option value="VT">Vermont</option>
					<option value="VA">Virginia</option>
					<option value="WA">Washington</option>
					<option value="WV">West Virginia</option>
					<option value="WI">Wisconsin</option>
					<option value="WY">Wyoming</option>
		        </select>
				:</h5>
				<!-- <ul class="fc-graphic-trend-list">
					<li class="fc-graphic-trend-item">&bull; 88% of Applied Learning requests (1st of 50)</li>
					<li class="fc-graphic-trend-item">&bull; 38% of Special Needs requests (49th of 50)</li>
				</ul> -->	
			</section>
			<section class="fc-graphic-content-block">
				<p class="fc-graphic-annotation fc-graphic-annotation-requests"></p>
				<div class="fc-stacked-bar">
					<p class="fc-graphic-label fc-graphic-requested">Requested</p>
					<p class="fc-graphic-label fc-graphic-fulfilled">Fulfilled</p>
				</div>
				<p class="fc-graphic-annotation fc-graphic-annotation-funded"></p>
				<ol class="fc-graphic-legend">
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Literacy &amp; Language</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Math &amp; Science</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Music &amp; Arts</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Applied Learning</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Special Needs</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">History &amp; Civics</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Health &amp; Sports</span></li>
					<li class="fc-graphic-legend-item"><span class="fc-graphic-legend-text">Data insufficient</span></li>
				</ol>	<span class="fc-graphic-legend-text">
			</section><span class="fc-graphic-legend-text">
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">Explore the Extremes</h5>
				<ol class="fc-graphic-extremes-list">
					<li class="fc-graphic-extremes-item" data-state="MI"><a href="#" class="fc-graphic-tag">Most Funded Overall</a></li>
					<li class="fc-graphic-extremes-item" data-state="IN"><a href="#" class="fc-graphic-tag">Least Funded Overall</a></li>
					<li class="fc-graphic-extremes-item" data-state="ND"><a href="#" class="fc-graphic-tag">Least Resource Requests</a></li>
					<li class="fc-graphic-extremes-item" data-state="CA"><a href="#" class="fc-graphic-tag">Most Resource Requests</a></li>
					<li class="fc-graphic-extremes-item" data-state="NH"><a href="#" class="fc-graphic-tag">Least Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item" data-state="ME"><a href="#" class="fc-graphic-tag">Most Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item" data-state="VT"><a href="#" class="fc-graphic-tag">Least Funded Special Needs</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Funded Applied Learning</a></li>
				</ol>	
			</section>
			<span class="sources-copy"><span class="sources-leadin">Source:</span> Donors Choose</span>
		</div>

		<!-- D3 STACKED BAR LAYOUT -->
		<script>

			var DATA, REQUESTS, FULFILLED, CONNECTORS, CHART, XSCALE;
			
			STATE = $('select').val();

			var width = $('.fc-graphic-legend').width(),
			    height = 102;

			XSCALE = d3.scale.linear()
			    .rangeRound([0, width]);

			// Sets ordinal scale
			var eachState = d3.scale.ordinal();
			    

			// Adds SVG element, append a container g element for each state
			CHART = d3.select(".fc-stacked-bar").append("svg")
			    .attr("width", width)
			    .attr("height", height)
			  
			CHART.append("g")
			  	.attr("class", "state-container");

			// DAT DATA
			d3.tsv("requests.tsv", function(error, data) {

			  DATA = data;
			  		
			  // Only returns index
			  eachState.domain(d3.keys(DATA[0]).filter(function(key, index) {
				    if( (index > 0) && (index < 8) ) {
				    	return key; 
			    	} else {
			    		return;
			    	} 
			  }));

			  DATA.forEach(function(d) {
			    var x0 = 0;
			    var stateArray = $.map(d, function (value) { return value; });

			    // Whatever is returned becomes a
			    var reqTotal = stateArray.reduce(function(a, b, index, array){
			    	if( (index > 1) && (index < 8) ) {
					  return parseInt(a) + parseInt(b);
			    	} else if ( index < 2 ) {
			    		return b;
			    	} else {
			    		return a;
			    	}
				});

				var filledTotal = stateArray.reduce(function(a, b, index, array){
			    	if( (index > 8)) {
					  return parseInt(a) + parseInt(b);
			    	} else {
			    		return b ;
			    	}
				});

			    // Add Total property to each state object
			    d.reqTotal = reqTotal;
			    d.filledTotal = filledTotal;

			    // Creates a new sub-array in each d that holds the returned vals
			    // Putting reqTotal into each item for easy access in the filled width calc in the updateData function
			    d.categories = eachState.domain().map(function(name, index) { 
				    	return {name: name, requested:+d[name], filled:+d["FILLED " + name], reqTotal:reqTotal, x0: x0, x1: x0 += +d[name]}; 
			    });

			    d.categories.forEach(function(d) { 
			    	d.x0 /= x0; d.x1 /= x0; 
			    });
			  });

			  var currentDatum = DATA.filter(function(row) {
		        return row['State'] == STATE;
		      });

		      REQUESTS = CHART.selectAll(".requests")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("class", "requests");

  			  CONNECTORS = CHART.selectAll(".connectors")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("transform", "translate(0,40)")
			      .attr("class", "connectors");

			  FULFILLED = CHART.selectAll(".fulfilled")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("transform", "translate(0,60)")
			      .attr("class", "fulfilled");

  			  updateData(STATE);

			});




			// HANDLERS

			$('select').on('change', function() {
			  STATE = this.value;
			  updateData(STATE);
			});

			$('.fc-graphic-extremes-item').on('click', function() {
			  var 	$this = $(this);
			  		STATE = $this.data( "state" );

			  updateData(STATE); // or $(this).val()
			  $('select').val(STATE);
			  $this.addClass("fc-graphic-extremes-active");
  			  $this.siblings().removeClass("fc-graphic-extremes-active");
			});

			// Resize
			window.addEventListener("resize", debounce(function () {
			    resize();
			}, 250), false);






			// HELPER FUNCTIONS

			function updateData(STATE) {		  
			  var currentDatum = DATA.filter(function(row) {
		        return row['State'] == STATE;
		      });

		      updateReqRects(currentDatum);
		      updateConnectPolys(currentDatum);
			  updateFilledRects(currentDatum);
			  updateAnnotations(currentDatum)
			}


			function updateReqRects(currentDatum) {
			  var reqRects = REQUESTS.selectAll("rect")
			      .data(currentDatum[0]['categories']);

			  reqRects.enter().append("rect")
			      .attr("height", "40")
			      .attr("class", function(d) { return d.name.replace(/[\s+\&]/g, ''); });

			   reqRects
   			      .attr("x", function(d) { return XSCALE(d.x0); })
   			      .attr("class", function(d) { 
			      	if (d.requested < 40){
				      	return "fc-insufficient"; 
			      	} else {
			      		return d.name.replace(/[\s+\&]/g, '');
			      	}
			      })
			      .attr("width", function(d) { return (XSCALE(d.x1) - XSCALE(d.x0)); });
			}


			function updateConnectPolys(currentDatum) {
			  var connectPolys = CONNECTORS.selectAll("polygon")
			      .data(currentDatum[0]['categories']);

			  connectPolys.enter().append("polygon")
				  .attr("class", function(d) { return d.name.replace(/[\s+\&]/g, ''); });

			   connectPolys
				  .attr("class", function(d) { 
			      	if (d.requested < 40){
				      	return "fc-insufficient"; 
			      	} else {
			      		return d.name.replace(/[\s+\&]/g, '');
			      	}
			      })
  			      .attr("points", function(d) { 
			      	return XSCALE(d.x0) + ",0 " + XSCALE(d.x1) + ",0 " + ( XSCALE(d.x0) + (XSCALE(d.x1) - XSCALE(d.x0)) * ( d.filled / d.requested ) ) + ",20 " + XSCALE(d.x0) + ",20";
			      });
			}


			function updateFilledRects(currentDatum) {
			  var filledRects = FULFILLED.selectAll("rect")
			      .data(currentDatum[0]['categories']);

			  filledRects.enter().append("rect")
			      .attr("height", "40")
			      .attr("class", function(d) { return d.name.replace(/[\s+\&]/g, ''); });

			   filledRects
   			      .attr("x", function(d) { return XSCALE(d.x0); })
  			      .attr("class", function(d) { 
			      	if (d.requested < 40){
				      	return "fc-insufficient"; 
			      	} else {
			      		return d.name.replace(/[\s+\&]/g, '');
			      	}
			      })
			      .attr("width", function(d) { return ( ( XSCALE(d.x1) - XSCALE(d.x0) ) * ( d.filled / d.requested ) ); });
			}


			function updateAnnotations(currentDatum) {
				var comma = d3.format(",");
				var percent = d3.format(".0%");

				$('.fc-graphic-annotation-requests').text("Teachers requested "+ comma(currentDatum[0].reqTotal) +" resources overall.");
				$('.fc-graphic-annotation-funded').text("Donors funded "+ percent(currentDatum[0].filledTotal/currentDatum[0].reqTotal, 0) +" of those requests.");
			}

			function debounce(fn, wait) {
			    var timeout;

			    return function () {
			        var context = this,              // preserve context
			            args = arguments,            // preserve arguments
			            later = function () {        // define a function that:
			                timeout = null;          // * nulls the timeout (GC)
			                fn.apply(context, args); // * calls the original fn
			            };

			        // (re)set the timer which delays the function call
			        clearTimeout(timeout);
			        timeout = setTimeout(later, wait);
			    };
			};

			function resize() {

				var currentDatum = DATA.filter(function(row) {
			        return row['State'] == STATE;
			    });

				// Update width
				var width = parseInt(d3.select('.fc-graphic-content-block').style('width'), 10);

				XSCALE = d3.scale.linear()
				    .rangeRound([0, width]);

				// Resize SVG element
				CHART.attr("width", width);

				// Recalc x0 and x1s
				DATA.forEach(function(d) {
				    var x0 = 0;
				    var stateArray = $.map(d, function (value) { return value; });

				    // Creates a new sub-array in each d that holds the returned vals
				    d.categories = eachState.domain().map(function(name, index) { 
					    	return {name: name, requested:+d[name], filled:+d["FILLED " + name], x0: x0, x1: x0 += +d[name]}; 
				    });

				    d.categories.forEach(function(d) { 
				    	d.x0 /= x0; d.x1 /= x0; 
				    });
				});


			    REQUESTS = CHART.selectAll(".requests")
				      .data(currentDatum);

	  			CONNECTORS = CHART.selectAll(".connectors")
				      .data(currentDatum);

				FULFILLED = CHART.selectAll(".fulfilled")
				      .data(currentDatum);

				// Redraw shapes
				updateReqRects(currentDatum);
			    updateConnectPolys(currentDatum);
				updateFilledRects(currentDatum);

			};

			// HACKITY HACKITY HACKITY to get around wrong SVG width due to width not being set by time d3 runs
			setTimeout(function(){ 
				resize();
				$(".fc-stacked-bar").css("opacity", "1");
			}, 150);


			</script>

	</article>

</body>

</html>
