<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width">
	<title>Resource Priorities</title>
	<link rel="stylesheet" href="css/site.css">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
</head>

<body>
		<article class="fc-graphic-article">
		<ul class="fc-decorative-border">
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
			<li class="fc-decorative-border-box"></li>
		</ul>
		<div class="fc-graphic-container">
			<h6 class="fc-graphic-overline">2008-2013</h6>
			<h4 class="fc-graphic-title">Resource Priorities</h4>
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">In 
				<select class="fc-graphic-select" tabindex="-1">
					<option value="AL">Alabama</option>
					<option value="AK">Alaska</option>
					<option value="AZ">Arizona</option>
					<option value="AR">Arkansas</option>
					<option value="CA">California</option>
					<option value="CO">Colorado</option>
					<option value="CT">Connecticut</option>
					<option value="DE">Delaware</option>
					<option value="FL">Florida</option>
					<option value="GA">Georgia</option>
					<option value="HI">Hawaii</option>
					<option value="ID">Idaho</option>
					<option value="IL">Illinois</option>
					<option value="IN">Indiana</option>
					<option value="IA">Iowa</option>
					<option value="KS">Kansas</option>
					<option value="KY">Kentucky</option>
					<option value="LA">Louisiana</option>
					<option value="ME">Maine</option>
					<option value="MD">Maryland</option>
					<option value="MA">Massachusetts</option>
					<option value="MI">Michigan</option>
					<option value="MN">Minnesota</option>
					<option value="MS">Mississippi</option>
					<option value="MO">Missouri</option>
					<option value="MT">Montana</option>
					<option value="NE">Nebraska</option>
					<option value="NV">Nevada</option>
					<option value="NH">New Hampshire</option>
					<option value="NJ">New Jersey</option>
					<option value="NM">New Mexico</option>
					<option value="NY" selected>New York</option>
					<option value="NC">North Carolina</option>
					<option value="ND">North Dakota</option>
					<option value="OH">Ohio</option>
					<option value="OK">Oklahoma</option>
					<option value="OR">Oregon</option>
					<option value="PA">Pennsylvania</option>
					<option value="RI">Rhode Island</option>
					<option value="SC">South Carolina</option>
					<option value="SD">South Dakota</option>
					<option value="TN">Tennessee</option>
					<option value="TX">Texas</option>
					<option value="UT">Utah</option>
					<option value="VT">Vermont</option>
					<option value="VA">Virginia</option>
					<option value="WA">Washington</option>
					<option value="WV">West Virginia</option>
					<option value="WI">Wisconsin</option>
					<option value="WY">Wyoming</option>
		        </select>
				, donors funded:</h5>
				<ul class="fc-graphic-trend-list">
					<li class="fc-graphic-trend-item">&bull; 88% of Applied Learning requests (1st of 50)</li>
					<li class="fc-graphic-trend-item">&bull; 38% of Special Needs requests (49th of 50)</li>
				</ul>	
			</section>
			<section class="fc-graphic-content-block">
				<p class="fc-graphic-annotation fc-graphic-annotation-requests">Teachers requested 7,603 resources overall.</p>
				<div class="fc-stacked-bar">
					<p class="fc-graphic-label fc-graphic-requested">Requested</p>
					<p class="fc-graphic-label fc-graphic-fulfilled">Fulfilled</p>
				</div>
				<p class="fc-graphic-annotation fc-graphic-annotation-funded">Donors funded 74% of those requests.</p>
				<ol class="fc-graphic-legend">
					<li class="fc-graphic-legend-item">Literacy &amp; Language</li>
					<li class="fc-graphic-legend-item">Math &amp; Science</li>
					<li class="fc-graphic-legend-item">Music &amp; Arts</li>
					<li class="fc-graphic-legend-item">Applied Learning</li>
					<li class="fc-graphic-legend-item">Special Needs</li>
					<li class="fc-graphic-legend-item">History &amp; Civics</li>
					<li class="fc-graphic-legend-item">Health &amp; Sports</li>
					<li class="fc-graphic-legend-item">Data insufficient</li>
				</ol>	
			</section>
			<section class="fc-graphic-content-block">
				<h5 class="fc-graphic-subhed">Explore the Extremes</h5>
				<ol class="fc-graphic-extremes-list">
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Funded Overall</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Least Resource Requests</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Resource Requests</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Least Funded Overall</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Funded Music &amp; Arts</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Least Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Funded History &amp; Civics</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Least Funded Special Needs</a></li>
					<li class="fc-graphic-extremes-item" data-state="AK"><a href="#" class="fc-graphic-tag">Most Funded Applied Learning</a></li>
				</ol>	
			</section>
			<span class="sources-copy"><span class="sources-leadin">SOURCE</span> Donors Choose</span>
		</div>

		<!-- D3 STACKED BAR LAYOUT -->
		<script>

			var DATA, REQUESTS, FULFILLED, CONNECTORS;
			var firstState = $('select').val();
			var pageWidth = parseInt(d3.select('.fc-graphic-content-block').style('width'));

			var margin = {top: 0, right: 0, bottom:0, left: 0},
			    width = pageWidth - margin.left - margin.right,
			    height = 102;

			var x = d3.scale.linear()
			    .rangeRound([0, width]);

			var y = d3.scale.ordinal()
			    .rangeRoundBands([height, 0]);

			// Sets bar colors
			var color = d3.scale.ordinal()
			    .range([
			    	"#FFDF80",
					"#FFB581",
					"#FF8A80",
					"#FF81CB",
					"#DF81FF",
					"#9288FF",
					"#81A0FF",
				 ]);

			// Adds SVG element, append a container g element for each state
			var svg = d3.select(".fc-stacked-bar").append("svg")
			    .attr("width", width + margin.left + margin.right)
			    .attr("height", height + margin.top + margin.bottom)
			  .append("g")
			  	.attr("class", "state-container");

			// DAT DATA
			d3.tsv("requests.tsv", function(error, data) {

			  DATA = data;
			  		
			  // Assigns the colors we set in the range to the columns of requests
			  color.domain(d3.keys(DATA[0]).filter(function(key, index) {
				    if( (index > 0) && (index < 8) ) {
				    	return key; 
			    	} else {
			    		return;
			    	} 
			  }));

			  DATA.forEach(function(d) {
			    var x0 = 0;
			    var stateArray = $.map(d, function (value) { return value; });

			    // Whatever is returned becomes a
			    var reqTotal = stateArray.reduce(function(a, b, index, array){
			    	if( (index > 1) && (index < 8) ) {
					  return parseInt(a) + parseInt(b);
			    	} else if ( index < 2 ) {
			    		return b;
			    	} else {
			    		return a;
			    	}
				});

				var filledTotal = stateArray.reduce(function(a, b, index, array){
			    	if( (index > 7)) {
					  return parseInt(a) + parseInt(b);
			    	} else {
			    		return b ;
			    	}
				});

			    // Add Total property to each state object
			    d.reqTotal = reqTotal;
			    d.filledTotal = filledTotal;

			    // Creates a new sub-array in each d that holds the returned vals
			    d.categories = color.domain().map(function(name, index) { 
				    	return {name: name, requested:+d[name], filled:+d["FILLED " + name], x0: x0, x1: x0 += +d[name]}; 
			    });

			    d.categories.forEach(function(d) { 
			    	d.x0 /= x0; d.x1 /= x0; 
			    });
			  });

			  console.log(DATA);

			  var currentDatum = DATA.filter(function(row) {
		        return row['State'] == 'NY';
		      });

		      REQUESTS = svg.selectAll(".requests")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("class", "requests");

  			  CONNECTORS = svg.selectAll(".connectors")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("transform", "translate(0,40)")
			      .attr("class", "connectors");

			  FULFILLED = svg.selectAll(".fulfilled")
			      .data(currentDatum)
			    .enter().append("g")
			      .attr("transform", "translate(0,60)")
			      .attr("class", "fulfilled");

  			  updateData('NY');

			});




			// HANDLERS

			$('select').on('change', function() {
			  updateData(this.value); // or $(this).val()
			});

			$('.fc-graphic-extremes-item').on('click', function() {
			  var state = $(this).data( "state" );

			  updateData(state); // or $(this).val()
			  $('select').val(state);
			});


			// HELPER FUNCTIONS
			function updateData(state) {
			  
			  var currentDatum = DATA.filter(function(row) {
		        return row['State'] == state;
		      });

			  // Append the segments of each state's bars to the container g element
			  var reqRects = REQUESTS.selectAll("rect")
			      .data(currentDatum[0]['categories']);
			      console.log(currentDatum);

			  reqRects.enter().append("rect")
			      .attr("height", "40")
			      .style("stroke", "white")
			      .style("fill", function(d) { return color(d.name); });

			   reqRects
   			      .attr("x", function(d) { return x(d.x0); })
			      .attr("width", function(d) { return (x(d.x1) - x(d.x0)); });


		      var connectPolys = CONNECTORS.selectAll("polygon")
			      .data(currentDatum[0]['categories']);

			  connectPolys.enter().append("polygon")
			      .style("stroke", "white")
			      .style("fill", function(d) { return color(d.name); });

			   connectPolys
  			      .attr("points", function(d) { 
			      	return x(d.x0) + ",0 " + x(d.x1) + ",0 " + ( x(d.x0) + (x(d.x1) - x(d.x0))*.75) + ",20 " + x(d.x0) + ",20";
			      });


			  var filledRects = FULFILLED.selectAll("rect")
			      .data(currentDatum[0]['categories']);

			  filledRects.enter().append("rect")
			      .attr("height", "40")
			      .style("stroke", "white")
			      .style("fill", function(d) { return color(d.name); });

			   filledRects
   			      .attr("x", function(d) { return x(d.x0); })
			      .attr("width", function(d) { return ( ( x(d.x1) - x(d.x0) )*.75 ); });

			}


			</script>

	</article>

</body>

</html>
